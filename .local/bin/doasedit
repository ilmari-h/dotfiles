#!/bin/bash

# This is a sudoedit replacement that works with doas.
# Simple wrapper that allows editing a file with root permissions using a text
# editor that has access to user specific config files.
#
# Note:
# You have to quit the editor to write to the edited file. This is because all
# this script does is:
# 
#   1. Copy the file to a user owned location.
#   2. Set user write permissions and open the file in an editor.
#   3. After closing the editor copies the file back and sets the same 
#      permissions as it originally had.
# 
# Use with caution, security sensitive operation.
#

[[ ! -z "${2}" ]] && echo "Too many arguments" && exit 1;
[[ -z "${1}" ]] && echo "No file provided" && exit 1;

auth=$AUTH 
[[ -z "${auth}" ]] && auth="doas";

editlocation=$(mktemp --suffix "-$1")
statusfile="/tmp/doasedit-${$}.status"

$auth doascopy.sh $1 $editlocation $(whoami) $statusfile & disown

while true
do
    if [[ -f $statusfile ]]; then
      break;
    else 
      sleep 0.1;
    fi
done &&

$EDITOR $editlocation &&
rm $statusfile

exit 0
